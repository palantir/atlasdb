

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Migration to Timelock Server &mdash; OSS AtlasDB develop documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/release-notes.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Manual Migration to Timelock Server" href="manual-migration.html" />
    <link rel="prev" title="Timelock Server Installation" href="installation.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> OSS AtlasDB
          

          
          </a>

          
            
            
              <div class="version">
                develop
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../overview/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../schemas/index.html">Schemas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../transactions/index.html">Transactions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration/index.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cluster_management/index.html">Cluster Management</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Services</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../key_value_services/index.html">Key Value Services</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lock_service/index.html">Lock Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../timestamp_service/index.html">Timestamp Service</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">External Timelock Service</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="installation.html">Timelock Server Installation</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Migration to Timelock Server</a></li>
<li class="toctree-l3"><a class="reference internal" href="manual-migration.html">Manual Migration to Timelock Server</a></li>
<li class="toctree-l3"><a class="reference internal" href="reverse-migration.html">Reverse Migration</a></li>
<li class="toctree-l3"><a class="reference internal" href="product-changes.html">Developing a product to use the timelock service</a></li>
<li class="toctree-l3"><a class="reference internal" href="paxos.html">Paxos and AtlasDB</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../qos_service/index.html">Qos Service</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../performance/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../miscellaneous/index.html">Miscellaneous</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting/index.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release_notes/index.html">Releases</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">OSS AtlasDB</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Services</a> &raquo;</li>
        
          <li><a href="index.html">External Timelock Service</a> &raquo;</li>
        
      <li>Migration to Timelock Server</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/palantir/atlasdb/blob/develop/docs/source/services/timelock_service/migration.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="migration-to-timelock-server">
<span id="timelock-migration"></span><h1>Migration to Timelock Server<a class="headerlink" href="#migration-to-timelock-server" title="Permalink to this headline">¶</a></h1>
<div class="section" id="why-migration">
<h2>Why Migration?<a class="headerlink" href="#why-migration" title="Permalink to this headline">¶</a></h2>
<p>AtlasDB assumes that timestamps returned by the timestamp service are monotonically increasing. In order to preserve
this guarantee when moving from an embedded timestamp service to an external timestamp service, we need to ensure
that timestamps issued by the external timestamp service are larger than those issued by the embedded one.
Otherwise, this can lead to serious data corruption.</p>
</div>
<div class="section" id="automated-migration">
<h2>Automated Migration<a class="headerlink" href="#automated-migration" title="Permalink to this headline">¶</a></h2>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Automated migrations are only implemented for Cassandra.</p>
</div>
<ol class="arabic simple">
<li>If you are using the Cassandra key value service and have added the <a class="reference internal" href="../../configuration/external_timelock_service_configs/timelock_client_config.html#timelock-client-configuration"><span class="std std-ref">Timelock client configuration</span></a>, then starting/re-starting the service will automatically migrate the service.</li>
<li>If you are using any other KVS, please follow the instructions at <a class="reference internal" href="manual-migration.html#manual-timelock-migration"><span class="std std-ref">Manual Migration to Timelock Server</span></a>.</li>
</ol>
<div class="section" id="verification">
<h3>Verification<a class="headerlink" href="#verification" title="Permalink to this headline">¶</a></h3>
<p>It may be useful to verify that an automatic migration was carried out successfully. In addition to simply performing
smoke tests of your clients and checking that they still work, there are a few other ways of checking that the
migration occurred correctly.</p>
<ol class="arabic">
<li><p class="first"><strong>Request Logs</strong>: Find the TimeLock leader, and search its request logs for calls to the <code class="docutils literal notranslate"><span class="pre">fastForwardTimestamp</span></code>
endpoint. These should be called with a <code class="docutils literal notranslate"><span class="pre">currentTimestamp</span></code> query parameter, which should be the bound in the
embedded timestamp bound store before the migration.</p>
<p>This bound should be noted down before an upgrade, perhaps with <code class="docutils literal notranslate"><span class="pre">cqlsh</span></code> or other interface to the DB:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cqlsh&gt; USE keyspace;
cqlsh:keyspace&gt; SELECT * FROM &quot;_timestamp&quot;;

 key    | column1 | column2 | value
--------+---------+---------+---------------------
 0x7473 |  0x7473 |      -1 | 0x0001020304050607
</pre></div>
</div>
<p>Otherwise, if using Cassandra we can attempt to determine this bound, by finding the most recent occurrence of
<code class="docutils literal notranslate"><span class="pre">[CAS]</span> <span class="pre">Setting</span> <span class="pre">cached</span> <span class="pre">limit</span> <span class="pre">to</span> <span class="pre">{}.</span></code> in the AtlasDB client logs (across all AtlasDB clients). Note that this is
logged at INFO level by the <a class="reference internal" href="../../configuration/logging.html#debug-logging"><span class="std std-ref">DebugLogger</span></a>, so if you have directed that to a separate
appender you will need to search in those logs instead.</p>
</li>
<li><p class="first"><strong>Key-Value Service table state</strong>: Check the state of the key-value service. For Cassandra, you should expect
to see two rows: <code class="docutils literal notranslate"><span class="pre">oldTs</span></code> (the backed up value of the timestamp bound) and
<code class="docutils literal notranslate"><span class="pre">ts</span></code> (a bogus one byte array indicating that the timestamp table has been invalidated). The <code class="docutils literal notranslate"><span class="pre">oldTs</span></code> value
should match the <code class="docutils literal notranslate"><span class="pre">currentTimestamp</span></code> values in the request logs.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cqlsh&gt; USE keyspace;
cqlsh:keyspace&gt; SELECT * FROM &quot;_timestamp&quot;;

 key    | column1      | column2 | value
--------+--------------+---------+---------------------
 0x7473 | 0x6f6c645473 |      -1 | 0x0001020304050607
 0x7473 |       0x7473 |      -1 |               0x00
</pre></div>
</div>
<p>We store timestamps as blobs in Cassandra, but the entry in the request logs is in decimal. One way of checking
they are equal is by converting the <code class="docutils literal notranslate"><span class="pre">oldTs</span></code> value to decimal through the shell:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ echo $((0x0001020304050607))
283686952306183
</pre></div>
</div>
</li>
<li><p class="first"><strong>AtlasDB Client Logs</strong>: Search for <code class="docutils literal notranslate"><span class="pre">[BACKUP]</span> <span class="pre">Backed</span> <span class="pre">up</span> <span class="pre">the</span> <span class="pre">value</span> <span class="pre">{}</span></code> in the AtlasDB client logs. This should
occur precisely once, and the value should match that as retrieved by the aforementioned methods.</p>
</li>
</ol>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="manual-migration.html" class="btn btn-neutral float-right" title="Manual Migration to Timelock Server" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="installation.html" class="btn btn-neutral" title="Timelock Server Installation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Palantir Technologies.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'develop',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>