

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>12. Batch timestamp requests on the client side &mdash; OSS AtlasDB develop documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../../_static/release-notes.css" type="text/css" />
  
    <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../search.html"/>
    <link rel="top" title="OSS AtlasDB develop documentation" href="../../../index.html"/>
        <link rel="up" title="Architecture Decision Records" href="index.html"/>
        <link rel="next" title="KeyValueService Status" href="../../kvs-status-check.html"/>
        <link rel="prev" title="11. Retry long-running locks via BlockingTimeoutException" href="0011-retry-long-running-locks-via-blockingtimeoutexception.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> OSS AtlasDB
          

          
          </a>

          
            
            
              <div class="version">
                develop
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../overview/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../schemas/index.html">Schemas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../transactions/index.html">Transactions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../configuration/index.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cluster_management/index.html">Cluster Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../performance/index.html">Performance Testing</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Miscellaneous</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../contributing.html">Contributing to AtlasDB</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Architecture Decision Records</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="0001-record-architecture-decisions.html">1. Record architecture decisions</a></li>
<li class="toctree-l3"><a class="reference internal" href="0002-prevent-tables-from-being-creating-simultaneously-in-cassandra-via-a-locks-table.html">2. Prevent tables from being created simultaneously in cassandra via a locks table</a></li>
<li class="toctree-l3"><a class="reference internal" href="0003-tagging-for-releases-and-long-term-support.html">3. Tagging for releases and long-term support</a></li>
<li class="toctree-l3"><a class="reference internal" href="0004-create-schema-lock-table-via-a-one-off-cli-command.html">4. Create schema lock table via a one off CLI command</a></li>
<li class="toctree-l3"><a class="reference internal" href="0005-stop-allowing-embedded-lock-and-timestamp-services-in-production.html">5. stop allowing embedded lock and timestamp services in production</a></li>
<li class="toctree-l3"><a class="reference internal" href="0006-create-schema-lock-table-using-configuration.html">6. Create schema lock table using configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="0007-use-cql-for-column-paging-for-sweep.html">7. Use CQL for column paging for sweep</a></li>
<li class="toctree-l3"><a class="reference internal" href="0008-add-heartbeat-for-schema-lock-holders.html">8. Adding Heartbeat for Schema Lock Holders</a></li>
<li class="toctree-l3"><a class="reference internal" href="0009-load-and-read-streams-in-same-transaction.html">9. Load and Read Streams in the Same Transaction</a></li>
<li class="toctree-l3"><a class="reference internal" href="0010-use-partial-row-complete-cell-batching-in-gettimestampsbycell.html">10. Use partial row complete cell batching in getTimestampsByCell</a></li>
<li class="toctree-l3"><a class="reference internal" href="0011-retry-long-running-locks-via-blockingtimeoutexception.html">11. Retry long-running locks via BlockingTimeoutException</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">12. Batch timestamp requests on the client side</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../kvs-status-check.html">KeyValueService Status</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dropwizard-metrics.html">AtlasDB Metrics</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../troubleshooting/index.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release_notes/index.html">Releases</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">OSS AtlasDB</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Miscellaneous</a> &raquo;</li>
        
          <li><a href="index.html">Architecture Decision Records</a> &raquo;</li>
        
      <li>12. Batch timestamp requests on the client side</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/palantir/atlasdb/blob/develop/docs/source/miscellaneous/doc/adr/0012-batch-timestamp-requests-on-the-client-side.md" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="batch-timestamp-requests-on-the-client-side">
<span id="batch-timestamp-requests-on-the-client-side"></span><h1>12. Batch timestamp requests on the client side<a class="headerlink" href="#batch-timestamp-requests-on-the-client-side" title="Permalink to this headline">¶</a></h1>
<p>Date: 26/09/2017</p>
<div class="section" id="status">
<span id="status"></span><h2>Status<a class="headerlink" href="#status" title="Permalink to this headline">¶</a></h2>
<p>Accepted</p>
</div>
<div class="section" id="context">
<span id="context"></span><h2>Context<a class="headerlink" href="#context" title="Permalink to this headline">¶</a></h2>
<p>A TimeLock cluster can serve multiple services. Under these circumstances, each TimeLock client node can separately
open connections to TimeLock and request timestamps and locks. As timestamp and lock requests are typically very common
(for instance, a single write transaction needs to contact TimeLock multiple times), TimeLock tends to experience
relatively heavy loads. This affects overall throughput, as TimeLock takes longer to respond to requests.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">PersistentTimestampService</span></code> supports querying for a contiguous range of timestamps. This functionality has
already been used in production, in Palantir’s large internal product.</p>
</div>
<div class="section" id="decision">
<span id="decision"></span><h2>Decision<a class="headerlink" href="#decision" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Use the <code class="docutils literal notranslate"><span class="pre">RequestBatchingTimestampService</span></code> to coalesce timestamp requests to TimeLock, and enable it by default.
This means that a TimeLock client will, at any time, have at most one timestamp request in flight to TimeLock.
When a client makes a request, if there is no request in-flight, the request is submitted immediately.
Otherwise, requests accumulate in a batch. Once the in-flight request completes, the batch request is sent as a
<code class="docutils literal notranslate"><span class="pre">getFreshTimestamps</span></code> request for the relevant number of timestamps, and the <code class="docutils literal notranslate"><span class="pre">TimestampRange</span></code> returned is distributed
among the threads that made the request.</li>
<li>Configure <code class="docutils literal notranslate"><span class="pre">RequestBatchingTimestampService</span></code> with a delay interval of zero milliseconds. In practice, this means that
when a request returns, the next request will immediately be dispatched (provided timestamps have actually been
requested). This does imply that, on average, requests take half a round-trip time longer. In practice, things
are more complex:<ul>
<li>In addition to the half-RTT, we also incur costs involved in synchronization of the batching.</li>
<li>TimeLock itself tends to respond more quickly, though, as it is less heavily loaded. For many internal contexts,
TimeLock being less heavily loaded is a particularly compelling reason to enable batching by default, as it
serves timestamps and locks for many services.</li>
</ul>
</li>
<li>Maintain the ability to disable request batching. This was kept, because request batching can cause a modest
increase in latency especially where client loads are light. Request batching might not be appropriate for
applications that require real-time responses.</li>
</ul>
</div>
<div class="section" id="consequences">
<span id="consequences"></span><h2>Consequences<a class="headerlink" href="#consequences" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Generally, load on TimeLock servers should be reduced, as there will be fewer network calls made to request
timestamps. Note that lock requests (both to the legacy and async lock services), as well as compound
operations like <code class="docutils literal notranslate"><span class="pre">lockImmutableTimestamp</span></code> are not batched.</li>
<li>Clients may experience an increase in latency, especially if TimeLock was not previously heavily loaded.
If so, they should consider disabling timestamp batching by setting the <code class="docutils literal notranslate"><span class="pre">enableTimestampBatching</span></code> parameter in the
<code class="docutils literal notranslate"><span class="pre">timestampClient</span></code> block of the AtlasDB runtime configuration to false.</li>
<li>Users analysing timestamp metrics should evaluate the performance of <code class="docutils literal notranslate"><span class="pre">TimestampService.getFreshTimestamps</span></code> as opposed
to <code class="docutils literal notranslate"><span class="pre">TimelockService.getFreshTimestamp</span></code> when trying to determine how quickly timestamps are served. This metric
includes the time involved in waiting for the current batch to complete as well as synchronization of batches.</li>
</ul>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../kvs-status-check.html" class="btn btn-neutral float-right" title="KeyValueService Status" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="0011-retry-long-running-locks-via-blockingtimeoutexception.html" class="btn btn-neutral" title="11. Retry long-running locks via BlockingTimeoutException" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Palantir Technologies.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'develop',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>