<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Internal Schema Configuration &mdash; OSS AtlasDB develop documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/release-notes.css" type="text/css" />
      <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Cluster Management" href="../cluster_management/index.html" />
    <link rel="prev" title="Timestamp Client Options" href="timestamp_client.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> OSS AtlasDB
          </a>
              <div class="version">
                develop
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../overview/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../schemas/index.html">Schemas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../transactions/index.html">Transactions</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Configuration</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="key_value_service_configs/index.html">Key Value Service Configurations</a></li>
<li class="toctree-l2"><a class="reference internal" href="external_timelock_service_configs/index.html">External Timelock Service Configurations</a></li>
<li class="toctree-l2"><a class="reference internal" href="cassandra_config.html">Cassandra Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="multinode_cassandra.html">Multinode Cassandra HA Guarantees</a></li>
<li class="toctree-l2"><a class="reference internal" href="enabling_cassandra_tracing.html">Enabling Cassandra Tracing</a></li>
<li class="toctree-l2"><a class="reference internal" href="leader_config.html">Leader Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="logging.html">Logging Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="timestamp_client.html">Timestamp Client Options</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Internal Schema Configuration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../cluster_management/index.html">Cluster Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../miscellaneous/index.html">Miscellaneous</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting/index.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release_notes/index.html">Releases</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">OSS AtlasDB</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Configuration</a> &raquo;</li>
      <li>Internal Schema Configuration</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/palantir/atlasdb/blob/develop/docs/source/configuration/internal_schemas.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="internal-schema-configuration">
<span id="id1"></span><h1>Internal Schema Configuration<a class="headerlink" href="#internal-schema-configuration" title="Permalink to this headline"></a></h1>
<p>This document covers configuration pertaining to settings about the internal schema that AtlasDB uses for storing
some of its state. These settings should be specified under the <code class="docutils literal notranslate"><span class="pre">internalSchema</span></code> key in an
<code class="docutils literal notranslate"><span class="pre">AtlasDbRuntimeConfiguration</span></code>.</p>
<p>For a full list of the configurations available at this block, see
<a class="reference external" href="https://github.com/palantir/atlasdb/blob/develop/atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/internalschema/InternalSchemaConfig.java">InternalSchemaConfig.java</a>.</p>
<section id="target-transactions-schema-version">
<h2>Target Transactions Schema Version<a class="headerlink" href="#target-transactions-schema-version" title="Permalink to this headline"></a></h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>_transactions2 and _transactions3 are currently only supported for Cassandra and In-Memory KVSes.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Schema versions 1 and 2 are vulnerable to a Cassandra consistency issue. Cassandra users should use
schema version 3. Users of other key-value-services are not affected by this issue.</p>
</div>
<p>AtlasDB needs to persist information about the start and commit timestamps of transactions that have committed.
This may be done in various ways, and is configurable. We currently support three strategies:</p>
<ul class="simple">
<li><p>version 1, which variable-length encodes the start and commit timestamps and stores them in the <code class="docutils literal notranslate"><span class="pre">_transactions</span></code>
table.</p></li>
<li><p>version 2, which variable-length encodes the start and commit timestamps following the
<a class="reference external" href="https://github.com/palantir/atlasdb/blob/develop/atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/encoding/TicketsEncodingStrategy.java">TicketsEncodingStrategy</a>,
storing them in the <code class="docutils literal notranslate"><span class="pre">_transactions2</span></code> table.</p></li>
<li><p>version 3, which variable-length encodes the start and commit timestamps following the
<a class="reference external" href="https://github.com/palantir/atlasdb/blob/develop/atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/encoding/TwoPhaseEncodingStrategy.java">TwoPhaseEncodingStrategy</a>,
storing them in the <code class="docutils literal notranslate"><span class="pre">_transactions2</span></code> table. This encoding strategy is for start timestamps consistent with the
TicketsEncodingStrategy, meaning that it is permissible to use the same table, but the encoding of commit timestamps
uses a two-phase commit protocol to avoid consistency issues.</p></li>
</ul>
<p>If specified, this AtlasDB client will attempt to install the provided transaction schema version. This parameter is
optional; if it is not specified, this AtlasDB client will not install any new transaction schema versions, and will
run with whatever version is already installed (1 by default).</p>
<p>New versions can be specified in a live fashion without downtime, though there are two caveats to be aware of:</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">TransactionSchemaInstaller</span></code> which installs new versions of transactions schemas only reads the configuration once every 10 minutes.
If a faster installation is required, you can bounce one service node, as this is read on startup. In HA configurations, this will not
require any downtime. After installation is done, a log message of the following form will be logged:</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&quot;We attempted to install the transactions schema version {}, and this was successful. This version will take effect no later than timestamp {}. (newVersion: 2, timestamp: 25161223)&quot;
</pre></div>
</div>
<ul class="simple">
<li><p>The AtlasDB timestamp still needs to progress forward to that point before we use the new transactions schema version.
If needed, one can force the new version to be used by fast-forwarding the timestamp to that point. To do this, see
<a class="reference internal" href="../services/timestamp_service/management.html#timestamp-service-management"><span class="std std-ref">Timestamp Service Management</span></a>.</p></li>
</ul>
<p>Users can also consider the metrics produced in <code class="docutils literal notranslate"><span class="pre">MetadataCoordinationServiceMetrics</span></code> - currently, the following
metrics are available:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">eventualTransactionsSchemaVersion</span></code> which should change to the target version after the intention to upgrade the
transactions schema version has been installed by the coordination service. Note that the AtlasDB timestamp
still needs to progress to the point where the new version actually comes into effect.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">currentTransactionsSchemaVersion</span></code> which, at the time the metric measurement was taken, yields the schema version at
a fresh timestamp. Note that this value may be cached (by default for up to 10 seconds) and metrics readings may only
be taken at an interval, so it may be slightly out of sync, though it should be close.</p></li>
</ul>
<p>The AtlasDB <code class="docutils literal notranslate"><span class="pre">CoordinationStore</span></code>, <code class="docutils literal notranslate"><span class="pre">CoordinationService</span></code> and <code class="docutils literal notranslate"><span class="pre">TransactionService</span></code> interfaces are also instrumented with
standard histograms for endpoint call rates and service times. Also, if using Cassandra KVS, it may be useful to
consider Cassandra metrics for the <code class="docutils literal notranslate"><span class="pre">_coordination</span></code> table.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="timestamp_client.html" class="btn btn-neutral float-left" title="Timestamp Client Options" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../cluster_management/index.html" class="btn btn-neutral float-right" title="Cluster Management" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017, Palantir Technologies.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>