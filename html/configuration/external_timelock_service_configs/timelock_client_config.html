

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Timelock Client Configuration &mdash; OSS AtlasDB develop documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/release-notes.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Cassandra Configuration" href="../cassandra_config.html" />
    <link rel="prev" title="Timelock Server Configuration" href="timelock_server_config.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> OSS AtlasDB
          

          
          </a>

          
            
            
              <div class="version">
                develop
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../overview/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../schemas/index.html">Schemas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../transactions/index.html">Transactions</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Configuration</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../key_value_service_configs/index.html">Key Value Service Configurations</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">External Timelock Service Configurations</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="timelock_server_config.html">Timelock Server Configuration</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Timelock Client Configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../cassandra_config.html">Cassandra Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../multinode_cassandra.html">Multinode Cassandra HA Guarantees</a></li>
<li class="toctree-l2"><a class="reference internal" href="../enabling_cassandra_tracing.html">Enabling Cassandra Tracing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../leader_config.html">Leader Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging.html">Logging Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../timestamp_client.html">Timestamp Client Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="../internal_schemas.html">Internal Schema Configuration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../cluster_management/index.html">Cluster Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../performance/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../miscellaneous/index.html">Miscellaneous</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting/index.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release_notes/index.html">Releases</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">OSS AtlasDB</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Configuration</a> &raquo;</li>
        
          <li><a href="index.html">External Timelock Service Configurations</a> &raquo;</li>
        
      <li>Timelock Client Configuration</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            
              <a href="https://github.com/palantir/atlasdb/blob/develop/docs/source/configuration/external_timelock_service_configs/timelock_client_config.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <section id="timelock-client-configuration">
<span id="id1"></span><h1>Timelock Client Configuration<a class="headerlink" href="#timelock-client-configuration" title="Permalink to this headline">¶</a></h1>
<p>You will need to update your AtlasDB configuration in order to have said clients request timestamps and locks from
external Timelock Servers as opposed to their embedded services. This is an extension of the leader block configuration
options discussed at <a class="reference internal" href="../leader_config.html#leader-config"><span class="std std-ref">Leader Configuration</span></a>.</p>
<p>TimeLock client configuration spans both <code class="docutils literal notranslate"><span class="pre">install</span></code> and <code class="docutils literal notranslate"><span class="pre">runtime</span></code> configuration.</p>
<section id="install-time-configuration">
<h2>Install-Time Configuration<a class="headerlink" href="#install-time-configuration" title="Permalink to this headline">¶</a></h2>
<p>Instead of configuring a <code class="docutils literal notranslate"><span class="pre">leader</span></code> block, or both a <code class="docutils literal notranslate"><span class="pre">timestamp</span></code> and <code class="docutils literal notranslate"><span class="pre">lock</span></code> block, one must instead specify a
single <code class="docutils literal notranslate"><span class="pre">timelock</span></code> block if your product uses the Timelock Server. The <code class="docutils literal notranslate"><span class="pre">leader</span></code> block and the <code class="docutils literal notranslate"><span class="pre">timestamp</span></code>/<code class="docutils literal notranslate"><span class="pre">lock</span></code>
blocks must be absent from the config if you are using the Timelock Server.</p>
<div class="admonition danger">
<p class="admonition-title">Danger</p>
<p>Changing the TimeLock <code class="docutils literal notranslate"><span class="pre">client</span></code> will mean that one receives timestamps from a different timestamp service.
This may result in <strong>SEVERE DATA CORRUPTION</strong> as the timestamp service’s guarantees may be broken.
Doing this safely requires a fast forward of the new client to at least the highest timestamp given out from the old client.
Please contact the AtlasDB team for assistance on such an operation.</p>
</div>
<p>Required parameters:</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 11%" />
<col style="width: 89%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Property</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>client</p></td>
<td><p>The name of your client, generally the same as your application name.
Note that if the top-level AtlasDB <code class="docutils literal notranslate"><span class="pre">namespace</span></code> configuration parameter is set, then this parameter need not be set.
However, if it is, then this parameter MUST be equal to the AtlasDB <code class="docutils literal notranslate"><span class="pre">namespace</span></code>, or AtlasDB will fail to start.</p>
<p>Note that client names must be non-empty and consist of only alphanumeric characters, dashes and
underscores (succinctly, <code class="docutils literal notranslate"><span class="pre">[a-zA-Z0-9_-]+</span></code>) and for backwards compatibility cannot be the reserved word <code class="docutils literal notranslate"><span class="pre">leader</span></code>.</p>
</td>
</tr>
</tbody>
</table>
<p>Optional parameters:</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Specifying the <code class="docutils literal notranslate"><span class="pre">serversList</span></code> (a <code class="docutils literal notranslate"><span class="pre">ServerListConfig</span></code>) in the install configuration has been deprecated, but is
maintained for backward compatibility. Please switch to declaring the <code class="docutils literal notranslate"><span class="pre">ServerListConfig</span></code> in the runtime
configuration as soon as possible.</p>
<p>Also, note that we internally select <code class="docutils literal notranslate"><span class="pre">serverList</span></code> blocks as a whole, prioritising the block in the runtime
configuration if it exists. In other words, if you want to specify a dynamic list of TimeLock nodes but a static
security configuration, the static security configuration <strong>must</strong> be placed in the runtime configuration block.</p>
</div>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 11%" />
<col style="width: 89%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Property</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>serversList::servers</p></td>
<td><p>A list of all hosts. The hosts must be specified as addresses, i.e. <code class="docutils literal notranslate"><span class="pre">https://host:port</span></code>.
AtlasDB assumes that the Timelock Servers being pointed at are part of the same Timelock cluster.
If this is not provided, it defaults to the empty list.</p></td>
</tr>
<tr class="row-odd"><td><p>serversList::sslConfiguration</p></td>
<td><p>The SSL configuration of the service. This should follow the
<a class="reference external" href="https://github.com/palantir/conjure-java-runtime-api/blob/2.3.0/ssl-config/src/main/java/com/palantir/conjure/java/api/config/ssl/SslConfiguration.java">palantir/http-remoting-api</a>
library. This should also be in alignment with the protocol used when configuring the servers.</p></td>
</tr>
<tr class="row-even"><td><p>serversList::proxyConfiguration</p></td>
<td><p>The proxy configuration of the service. This should follow the
<a class="reference external" href="https://github.com/palantir/conjure-java-runtime-api/blob/2.3.0/service-config/src/main/java/com/palantir/conjure/java/api/config/service/ProxyConfiguration.java">palantir/http-remoting-api</a>
library.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="runtime-configuration">
<h2>Runtime Configuration<a class="headerlink" href="#runtime-configuration" title="Permalink to this headline">¶</a></h2>
<div class="admonition danger">
<p class="admonition-title">Danger</p>
<p>Although we support live-reloading of the server configuration, AtlasDB needs to know at install time that it
should talk to TimeLock. Added the block to a running service using embedded timestamp and lock servers is unsafe,
as a rolling restart is likely to cause <strong>SEVERE DATA CORRUPTION</strong>.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Although we support starting up without knowledge of any TimeLock nodes, note that if you are using TimeLock
your service will fail to start if there are no TimeLock nodes and asynchronous initialization
(<code class="docutils literal notranslate"><span class="pre">initializeAsync</span></code>) is set to <code class="docutils literal notranslate"><span class="pre">false</span></code>, as initializing a <code class="docutils literal notranslate"><span class="pre">TransactionManager</span></code> requires communication with
TimeLock.</p>
</div>
<p>We support live reloading of the <code class="docutils literal notranslate"><span class="pre">ServerListConfiguration</span></code> for TimeLock. This can be optionally configured in the
<code class="docutils literal notranslate"><span class="pre">timelockRuntime</span></code> block under AtlasDB’s runtime configuration root.</p>
<p>Note that if this block is present, then the <code class="docutils literal notranslate"><span class="pre">ServerListConfiguration</span></code> in the install configuration will be ignored.</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 11%" />
<col style="width: 89%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Property</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>serversList::servers</p></td>
<td><p>A list of all hosts. The hosts must be specified as addresses, i.e. <code class="docutils literal notranslate"><span class="pre">https://host:port</span></code>.
AtlasDB assumes that the Timelock Servers being pointed at are part of the same Timelock cluster.
If this is not provided, it defaults to the empty list.</p></td>
</tr>
<tr class="row-odd"><td><p>serversList::sslConfiguration</p></td>
<td><p>The SSL configuration of the service. This should follow the
<a class="reference external" href="https://github.com/palantir/conjure-java-runtime-api/blob/2.3.0/ssl-config/src/main/java/com/palantir/conjure/java/api/config/ssl/SslConfiguration.java">palantir/http-remoting-api</a>
library. This should also be in alignment with the protocol used when configuring the servers.</p></td>
</tr>
<tr class="row-even"><td><p>serversList::proxyConfiguration</p></td>
<td><p>The proxy configuration of the service. This should follow the
<a class="reference external" href="https://github.com/palantir/conjure-java-runtime-api/blob/2.3.0/service-config/src/main/java/com/palantir/conjure/java/api/config/service/ProxyConfiguration.java">palantir/http-remoting-api</a>
library.</p></td>
</tr>
</tbody>
</table>
<section id="semantics-for-live-reloading">
<span id="id2"></span><h3>Semantics for Live Reloading<a class="headerlink" href="#semantics-for-live-reloading" title="Permalink to this headline">¶</a></h3>
<p>Feign and OkHttp do not appear to come with out-of-the-box for live reloading of proxy endpoints. Thus, when we
detect that the runtime config has changed, we create a new dynamic proxy.</p>
<p>Creating this proxy is a two step process. We first <em>resolve</em> the <code class="docutils literal notranslate"><span class="pre">serversList</span></code> configuration to be used - if there
is one present in the <code class="docutils literal notranslate"><span class="pre">timelockRuntime</span></code> block, then we use it. Otherwise we use the <code class="docutils literal notranslate"><span class="pre">serversList</span></code> configuration
from the <code class="docutils literal notranslate"><span class="pre">timelock</span></code> block in the install configuration.</p>
<p>What happens next depends on the size of the <code class="docutils literal notranslate"><span class="pre">serversList</span></code> used:</p>
<ol class="arabic simple">
<li><p>If the <code class="docutils literal notranslate"><span class="pre">serversList</span></code> appears to have zero nodes, we create a proxy that always throws a
<code class="docutils literal notranslate"><span class="pre">ServiceNotAvailableException</span></code>. Note that this functionality is important; we internally have scenarios
where user services are initially completely unaware of TimeLock nodes.</p></li>
<li><p>If the <code class="docutils literal notranslate"><span class="pre">serversList</span></code> has one or more nodes, we create a proxy that delegates requests to those nodes, failing over
to others if requests fail.</p></li>
</ol>
<p>The above mechanisms have a few implications. Most significantly, if the relevant <code class="docutils literal notranslate"><span class="pre">serversList</span></code> block is changed,
requests that are in-flight will still be on the old Feign proxy. These may continue retrying until failure if,
for example, the older configuration was unaware of the TimeLock cluster leader. Similarly, these requests may also
continue to retry on nodes which have been removed from the cluster owing to traffic or other limitations.</p>
</section>
</section>
<section id="timelock-configuration-examples">
<span id="timelock-config-examples"></span><h2>Timelock Configuration Examples<a class="headerlink" href="#timelock-configuration-examples" title="Permalink to this headline">¶</a></h2>
<p>Here is an example of an AtlasDB configuration with the <code class="docutils literal notranslate"><span class="pre">timelock</span></code> block.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If you are using Cassandra, then automated migration will be performed when starting up your AtlasDB clients.
If you are using another key-value-service, then you MUST ensure that you have migrated to the Timelock Server before
adding a <code class="docutils literal notranslate"><span class="pre">timelock</span></code> block to the config.</p>
</div>
<section id="install-configuration">
<h3>Install Configuration<a class="headerlink" href="#install-configuration" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In versions of AtlasDB before 0.74.0, you will need to specify an empty <code class="docutils literal notranslate"><span class="pre">timelock</span></code> block as a child of the
<code class="docutils literal notranslate"><span class="pre">atlasdb</span></code> block. This block looks like the following: <code class="docutils literal notranslate"><span class="pre">timelock:</span> <span class="pre">{}</span></code>.</p>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yourapp</span>

<span class="nt">atlasdb</span><span class="p">:</span>
  <span class="nt">keyValueService</span><span class="p">:</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cassandra</span>
    <span class="nt">servers</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">cassandra:9160</span>
    <span class="nt">poolSize</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">20</span>
    <span class="nt">credentials</span><span class="p">:</span>
      <span class="nt">username</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cassandra</span>
      <span class="nt">password</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cassandra</span>
    <span class="nt">sslConfiguration</span><span class="p">:</span>
      <span class="nt">trustStorePath</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">var/security/truststore.jks</span>
    <span class="nt">replicationFactor</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
    <span class="nt">mutationBatchCount</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10000</span>
    <span class="nt">mutationBatchSizeBytes</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10000000</span>
    <span class="nt">fetchBatchCount</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1000</span>
    <span class="nt">autoRefreshNodes</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>

  <span class="nt">initializeAsync</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
<p>The example above uses the <code class="docutils literal notranslate"><span class="pre">namespace</span></code> parameter; the <code class="docutils literal notranslate"><span class="pre">client</span></code> we will use when connecting to TimeLock will be <code class="docutils literal notranslate"><span class="pre">yourapp</span></code>.
We don’t know the URLs of the TimeLock servers nor how we will talk to them, but that is okay.</p>
</section>
<section id="id3">
<h3>Runtime Configuration<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In versions of AtlasDB before 0.74.0, if the <code class="docutils literal notranslate"><span class="pre">timelock</span></code> block was absent in the install configuration, then this
block would be ignored, and AtlasDB would start up using embedded timestamp and lock services.</p>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">timelockRuntime</span><span class="p">:</span>
  <span class="nt">serversList</span><span class="p">:</span>
    <span class="nt">servers</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;https://foo1:12345&quot;</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;https://foo2:8421&quot;</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;https://foo3:9421&quot;</span>
    <span class="nt">sslConfiguration</span><span class="p">:</span>
      <span class="nt">trustStorePath</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">var/security/trustStore.jks</span>
      <span class="nt">keyStorePath</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">var/security/keyStore.jks</span>
      <span class="nt">keyStorePassword</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0987654321</span>
</pre></div>
</div>
<p>AtlasDB will at runtime determine that the <code class="docutils literal notranslate"><span class="pre">client</span></code> to be used is <code class="docutils literal notranslate"><span class="pre">yourapp</span></code> and the servers are as indicated above,
and it will be able to route requests to TimeLock correctly.</p>
<p>Note that even if the <code class="docutils literal notranslate"><span class="pre">timelock</span></code> block in the install configuration included a <code class="docutils literal notranslate"><span class="pre">serversList</span></code> block, it would be
ignored, because we consider the <code class="docutils literal notranslate"><span class="pre">serversList</span></code> block in the runtime configuration to take precedence.</p>
<p>It is permitted for the <code class="docutils literal notranslate"><span class="pre">serversList</span></code> block here to be absent as well. In this case, AtlasDB will start up with
knowledge of zero TimeLock nodes. Attempts to initialize a <code class="docutils literal notranslate"><span class="pre">TransactionManager</span></code> will fail, but will continue
asynchronously in the background. Once the <code class="docutils literal notranslate"><span class="pre">serversList</span></code> block has been populated, initialization can proceed.</p>
</section>
</section>
</section>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../cassandra_config.html" class="btn btn-neutral float-right" title="Cassandra Configuration" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="timelock_server_config.html" class="btn btn-neutral float-left" title="Timelock Server Configuration" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2017, Palantir Technologies.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>